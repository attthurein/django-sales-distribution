{% extends "base.html" %}
{% load i18n humanize common_extras static %}

{% block title %}{% trans "Dashboard" %}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active" aria-current="page">{% trans "Dashboard" %}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<h1 class="mb-4">{% trans "Dashboard" %}</h1>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-gradient-primary h-100 shadow metric-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75"><i class="bi bi-currency-dollar"></i> {% trans "Today's Sales" %}
                        </h6>
                        <h3 class="card-title mb-0 fw-bold">{{ today_sales|floatformat:0|intcomma }}</h3>
                        <small class="opacity-75">{% currency_suffix %}</small>
                    </div>
                    <div class="fs-1 opacity-50">
                        <i class="bi bi-currency-dollar"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-gradient-info h-100 shadow metric-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75"><i class="bi bi-clock-history"></i> {% trans "Pending Orders" %}
                        </h6>
                        <h3 class="card-title mb-0 fw-bold">{{ pending_orders }}</h3>
                        <small class="opacity-75">{% trans "orders" %}</small>
                    </div>
                    <div class="fs-1 opacity-50">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <a href="{% url 'core:low_stock_list' %}" class="text-decoration-none">
            <div class="card text-white bg-gradient-warning h-100 shadow metric-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75"><i class="bi bi-exclamation-triangle"></i> {% trans "Low Stock" %}
                            </h6>
                            <h3 class="card-title mb-0 fw-bold">{{ low_stock_count }}</h3>
                            <small class="opacity-75">{% trans "products" %}</small>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-box-seam"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{% url 'reports:outstanding_payments' %}" class="text-decoration-none">
            <div class="card text-white bg-gradient-danger h-100 shadow metric-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75"><i class="bi bi-calendar-x"></i> {% trans "Overdue" %}</h6>
                            <h3 class="card-title mb-0 fw-bold">{{ overdue_count }}</h3>
                            <small class="opacity-75">{% trans "orders" %}</small>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-exclamation-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

{% if expiry_alert %}
<div class="alert alert-info d-flex align-items-start" role="alert">
    <div>
        <strong>{% trans "Expiry alert" %}</strong>: {% blocktrans count count=expiry_alert %}{{ count }} product expiring soon{% plural %}{{ count }} products expiring soon{% endblocktrans %}
        <a class="btn btn-sm btn-outline-dark mt-2 ms-2" href="{% url 'core:product_list' %}">{% trans "View Products" %}</a>
    </div>
</div>
{% endif %}
{% if low_stock_products %}
<div class="alert alert-warning d-flex align-items-start" role="alert">
    <div>
        <strong>{% trans "Low stock products" %}</strong>
        <ul class="mb-0">
            {% for p in low_stock_products %}
            <li>{{ p.name }} â€” {% trans "Stock" %}: {{ p.stock_quantity }} {% if p.unit %}{{ p.unit|master_name }}{% endif %}</li>
            {% endfor %}
        </ul>
        <a class="btn btn-sm btn-outline-dark mt-2" href="{% url 'core:low_stock_list' %}">{% trans "Go to Low Stock List" %}</a>
    </div>
</div>
{% endif %}

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card shadow h-100">
            <div class="card-header bg-white border-bottom"><i class="bi bi-receipt me-2"></i>{% trans "Recent Orders" %}</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-stack table-enhanced mb-0" data-stack>
                        <thead>
                            <tr>
                                <th><i class="bi bi-receipt"></i> {% trans "Order" %}</th>
                                <th><i class="bi bi-person"></i> {% trans "Customer" %}</th>
                                <th><i class="bi bi-tag"></i> {% trans "Type" %}</th>
                                <th><i class="bi bi-info-circle"></i> {% trans "Status" %}</th>
                                <th><i class="bi bi-currency-dollar"></i> {% trans "Amount" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_orders %}
                                {% for o in recent_orders %}
                                <tr>
                                    <td data-label="{% trans 'Order' %}"><a href="{% url 'orders:order_detail' o.pk %}">{{ o.order_number }}</a></td>
                                    <td data-label="{% trans 'Customer' %}">{{ o.customer.name }}</td>
                                    <td data-label="{% trans 'Type' %}">
                                        {% if o.order_type == 'REPLACEMENT' %}
                                            <span class="badge bg-warning text-dark"><i class="bi bi-arrow-repeat"></i> {% trans "Replacement" %}</span>
                                        {% elif o.order_type == 'PRE_ORDER' %}
                                            <span class="badge bg-info"><i class="bi bi-clock-history"></i> {% trans "Pre-order" %}</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark border">{% trans "Normal" %}</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="{% trans 'Status' %}">
                                        <span class="badge bg-info">{{ o.status|master_name }}</span>
                                    </td>
                                    <td data-label="{% trans 'Amount' %}">{{ o.total_amount|floatformat:0|intcomma }} {% currency_suffix %}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-muted text-center py-4">{% trans "No orders yet." %}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow h-100">
            <div class="card-header bg-white border-bottom"><i class="bi bi-arrow-return-left me-2"></i>{% trans "Recent Returns" %}</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-stack table-enhanced mb-0" data-stack>
                        <thead>
                            <tr>
                                <th>{% trans "Return" %}</th>
                                <th>{% trans "Status" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_returns %}
                                {% for r in recent_returns %}
                                <tr>
                                    <td data-label="{% trans 'Return' %}"><a href="{% url 'returns:return_detail' r.pk %}">{{ r.return_number }}</a></td>
                                    <td data-label="{% trans 'Status' %}"><span class="badge bg-secondary">{{ r.status|master_name }}</span></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-muted text-center py-4">{% trans "No returns" %}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-4">
        <div class="card shadow h-100">
            <div class="card-header bg-white border-bottom"><i class="bi bi-arrow-left-right me-2"></i>{% trans "Recent Stock Movements" %}</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-stack table-enhanced mb-0" data-stack>
                        <thead>
                            <tr>
                                <th>{% trans "Product" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Qty" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_movements %}
                                {% for m in recent_movements %}
                                <tr>
                                    <td data-label="{% trans 'Product' %}"><a href="{% url 'core:product_detail' m.product.pk %}">{{ m.product.name }}</a></td>
                                    <td data-label="{% trans 'Type' %}">{{ m.get_movement_type_display }}</td>
                                    <td data-label="{% trans 'Qty' %}">{{ m.quantity }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-muted text-center py-4">{% trans "No movements" %}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-white border-top">
                    <a href="{% url 'core:stock_movement_list' %}" class="btn btn-sm btn-outline-secondary">{% trans "View All" %}</a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow h-100">
            <div class="card-header bg-white border-bottom"><i class="bi bi-box-seam me-2"></i>{% trans "Stock Balances (Top)" %}</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-stack table-enhanced mb-0" data-stack>
                        <thead>
                            <tr>
                                <th>{% trans "Product" %}</th>
                                <th>{% trans "Category" %}</th>
                                <th>{% trans "Stock" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if products_with_stock %}
                                {% for p in products_with_stock %}
                                <tr>
                                    <td data-label="{% trans 'Product' %}"><a href="{% url 'core:product_detail' p.pk %}">{{ p.name }}</a></td>
                                    <td data-label="{% trans 'Category' %}">{% if p.category %}{{ p.category|master_name }}{% else %}-{% endif %}</td>
                                    <td data-label="{% trans 'Stock' %}">{{ p.stock_quantity }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-muted text-center py-4">{% trans "No products" %}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow h-100">
            <div class="card-header bg-white border-bottom"><i class="bi bi-pie-chart me-2"></i>{% trans "Stock by Category" %}</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-stack table-enhanced mb-0" data-stack>
                        <thead>
                            <tr>
                                <th>{% trans "Category" %}</th>
                                <th>{% trans "Total Stock" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if stock_by_category %}
                                {% for c in stock_by_category %}
                                <tr>
                                    <td data-label="{% trans 'Category' %}">{% if request.LANGUAGE_CODE == 'my' and c.category__name_my %}{{ c.category__name_my }}{% else %}{{ c.category__name_en|default:"-" }}{% endif %}</td>
                                    <td data-label="{% trans 'Total Stock' %}">{{ c.total|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-muted text-center py-4">{% trans "No stock data" %}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-white border-bottom"><i class="bi bi-calendar-event me-2"></i>{% trans "Expiring within 2 days (by shop)" %}</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <div class="d-flex justify-content-between align-items-center p-2">
                            <input type="text" class="form-control form-control-sm w-50" id="expShopSearch"
                                placeholder="{% trans 'Search product or shop' %}">
                        </div>
                        <table class="table table-striped table-stack mb-0" data-stack id="expShopTable">
                            <thead>
                                <tr>
                                    <th>{% trans "Product" %}</th>
                                    <th>{% trans "Expiry Date" %}</th>
                                    <th>{% trans "Phone" %}</th>
                                    <th>{% trans "Customer" %}</th>
                                    <th>{% trans "Remaining" %}</th>
                                    <th>{% trans "D-day" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if expiring_by_shop %}
                                    {% for x in expiring_by_shop %}
                                    <tr>
                                        <td data-label="{% trans 'Product' %}">{{ x.product_name }}</td>
                                        <td data-label="{% trans 'Expiry Date' %}">{{ x.expiry_date }}</td>
                                        <td data-label="{% trans 'Phone' %}">{{ x.phone }}</td>
                                        <td data-label="{% trans 'Customer' %}">{{ x.customer_name }}</td>
                                        <td data-label="{% trans 'Remaining' %}">{{ x.remaining }}</td>
                                        <td data-label="{% trans 'D-day' %}"><span
                                                class="badge {% if x.days_left <= 1 %}bg-danger{% else %}bg-warning{% endif %}"
                                                data-bs-toggle="tooltip" title="{% trans 'Days until expiry' %}">{{ x.days_left }}
                                                {% trans "days" %}</span></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-muted text-center py-4">{% trans "No expiring products" %}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}