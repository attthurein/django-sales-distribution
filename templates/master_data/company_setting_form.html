{% extends "base.html" %}
{% load widget_tweaks i18n static %}

{% block title %}{% trans "Company Setting" %}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">{% trans "Dashboard" %}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{% trans "Company Setting" %}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="row g-4">
        <!-- Left Column: Identity & System -->
        <div class="col-lg-4">
            <!-- Logo Card -->
            <div class="card shadow-sm border-0 rounded-3 mb-4">
                <div class="card-body text-center p-4">
                    <h5 class="card-title text-primary mb-4">{% trans "Company Logo" %}</h5>
                    
                    <div class="position-relative d-inline-block mb-3">
                         <div id="logo-preview-container" class="logo-preview-wrap" data-existing-url="{% if setting and setting.logo %}{{ setting.logo.url }}{% endif %}">
                            <img id="logo-preview" 
                                 src="{% if setting and setting.logo %}{{ setting.logo.url }}{% else %}{% static 'img/placeholder-logo.png' %}{% endif %}" 
                                 alt="Logo" 
                                 class="img-thumbnail rounded-circle shadow-sm {% if not setting.logo %}d-none{% endif %}" 
                                 style="width: 150px; height: 150px; object-fit: cover;">
                             <!-- Placeholder icon if no logo -->
                             <div id="logo-placeholder" class="rounded-circle bg-light d-flex align-items-center justify-content-center shadow-sm {% if setting.logo %}d-none{% endif %}" style="width: 150px; height: 150px; border: 2px dashed #dee2e6;">
                                <i class="bi bi-image text-muted fs-1"></i>
                             </div>
                        </div>
                        
                        <div class="mt-3">
                            <label for="id_logo" class="btn btn-outline-primary rounded-pill px-4">
                                <i class="bi bi-camera me-2"></i>{% trans "Change Logo" %}
                            </label>
                            <input type="file" name="logo" id="id_logo" class="d-none" accept="image/*">
                        </div>
                        <div class="form-text small mt-2">{% trans "Recommended: Square PNG or JPG, max 2MB" %}</div>
                    </div>
                    {% if form.logo.errors %}<div class="text-danger small mt-1">{{ form.logo.errors }}</div>{% endif %}
                </div>
            </div>

            <!-- System Configuration Card -->
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 fw-bold text-primary"><i class="bi bi-sliders me-2"></i>{% trans "System Configuration" %}</h6>
                </div>
                <div class="card-body p-4">
                    <label class="form-label fw-bold">{% trans "Base Currency" %}</label>
                    <p class="small text-muted mb-2">{% trans "The default currency used for all system transactions and reporting." %}</p>
                    
                    {% if base_currency_locked %}
                        <div class="input-group">
                            <span class="input-group-text bg-warning text-dark border-warning"><i class="bi bi-lock-fill"></i></span>
                            <select class="form-select bg-white" disabled>
                                <option value="{{ setting.base_currency_id|default:'' }}">
                                    {% if setting and setting.base_currency %}{{ setting.base_currency.name }} ({{ setting.base_currency.symbol }}){% else %}---{% endif %}
                                </option>
                            </select>
                        </div>
                        <input type="hidden" name="base_currency" value="{{ setting.base_currency_id|default:'' }}">
                        <div class="form-text text-warning mt-2 small">
                            <i class="bi bi-exclamation-circle"></i> {% trans "Cannot change: transactional data exists (orders, products, etc.)." %}
                        </div>
                    {% else %}
                        {{ form.base_currency|add_class:"form-select" }}
                        {% if form.base_currency.errors %}<div class="text-danger small mt-1">{{ form.base_currency.errors }}</div>{% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Business Details -->
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-3 h-100">
                <div class="card-header bg-primary text-white p-4 rounded-top-3">
                    <h2 class="h4 mb-0"><i class="bi bi-building me-2"></i>{% trans "Company Profile" %}</h2>
                    <p class="mb-0 opacity-75 mt-1 small">{% trans "Manage your company information and preferences" %}</p>
                </div>
                
                <div class="card-body p-4 p-md-5">
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger mb-4 d-flex align-items-center" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>{{ form.non_field_errors }}</div>
                    </div>
                    {% endif %}

                    <!-- Basic Information -->
                    <h5 class="text-primary border-bottom pb-2 mb-4"><i class="bi bi-info-circle me-2"></i>{% trans "Basic Information" %}</h5>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <div class="form-floating">
                                {{ form.name|add_class:"form-control"|attr:"placeholder:Company Name" }}
                                <label for="{{ form.name.id_for_label }}">{% trans "Company Name" %} <span class="text-danger">*</span></label>
                            </div>
                             {% if form.name.errors %}<div class="text-danger small ms-1">{{ form.name.errors }}</div>{% endif %}
                        </div>
                    </div>

                    <!-- Location -->
                    <h5 class="text-primary border-bottom pb-2 mb-4 mt-5"><i class="bi bi-geo-alt me-2"></i>{% trans "Location" %}</h5>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select name="country_id" id="id_country" class="form-select" aria-label="Country">
                                    <option value="">---</option>
                                    {% for country in countries %}
                                    <option value="{{ country.id }}" {% if setting and setting.township and setting.township.region.country_id == country.id %}selected{% endif %}>
                                        {{ country.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <label for="id_country">{% trans "Country" %}</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select name="region_id" id="id_region" class="form-select" aria-label="Region">
                                    <option value="">---</option>
                                    {% for country in countries %}
                                        {% for region in country.regions.all %}
                                        <option value="{{ region.id }}" data-country-id="{{ country.id }}" {% if setting and setting.region_id == region.id %}selected{% endif %}>
                                            {{ region.name }}
                                        </option>
                                        {% endfor %}
                                    {% endfor %}
                                </select>
                                <label for="id_region">{% trans "Region" %}</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select name="township" id="id_township" class="form-select" aria-label="Township">
                                    <option value="">---</option>
                                    {% for country in countries %}
                                        {% for region in country.regions.all %}
                                            {% for t in region.townships.all %}
                                            <option value="{{ t.id }}" data-region-id="{{ region.id }}" {% if setting and setting.township_id == t.id %}selected{% endif %}>
                                                {{ t.name }}
                                            </option>
                                            {% endfor %}
                                        {% endfor %}
                                    {% endfor %}
                                </select>
                                <label for="id_township">{% trans "Township" %}</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="form-floating">
                            {{ form.address|add_class:"form-control"|attr:"placeholder:Address"|attr:"style:height: 100px" }}
                            <label for="{{ form.address.id_for_label }}">{% trans "Full Address" %}</label>
                        </div>
                        {% if form.address.errors %}<div class="text-danger small ms-1">{{ form.address.errors }}</div>{% endif %}
                    </div>

                    <!-- Contact & Tax -->
                    <h5 class="text-primary border-bottom pb-2 mb-4 mt-5"><i class="bi bi-telephone me-2"></i>{% trans "Contact & Tax Details" %}</h5>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.phone|add_class:"form-control"|attr:"placeholder:Phone" }}
                                <label for="{{ form.phone.id_for_label }}">{% trans "Phone Number" %}</label>
                            </div>
                            {% if form.phone.errors %}<div class="text-danger small ms-1">{{ form.phone.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.email|add_class:"form-control"|attr:"placeholder:Email" }}
                                <label for="{{ form.email.id_for_label }}">{% trans "Email Address" %}</label>
                            </div>
                            {% if form.email.errors %}<div class="text-danger small ms-1">{{ form.email.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-12">
                            <div class="form-floating">
                                {{ form.tax_id|add_class:"form-control"|attr:"placeholder:Tax ID" }}
                                <label for="{{ form.tax_id.id_for_label }}">{% trans "Tax Identification Number" %}</label>
                            </div>
                            {% if form.tax_id.errors %}<div class="text-danger small ms-1">{{ form.tax_id.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-12">
                             <div class="form-floating">
                                {{ form.footer_text|add_class:"form-control"|attr:"placeholder:Footer Text"|attr:"style:height: 80px" }}
                                <label for="{{ form.footer_text.id_for_label }}">{% trans "Invoice Footer Text" %}</label>
                            </div>
                            <div class="form-text text-end">{% trans "This text will appear at the bottom of your invoices" %}</div>
                            {% if form.footer_text.errors %}<div class="text-danger small ms-1">{{ form.footer_text.errors }}</div>{% endif %}
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-5 pt-3 border-top">
                        <a href="{% url 'dashboard:index' %}" class="btn btn-light btn-lg px-4 me-md-2">{% trans "Cancel" %}</a>
                        <button type="submit" class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm">
                            <i class="bi bi-check2-circle me-2"></i> {% trans "Save Changes" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<style>
    .form-floating > label {
        color: #6c757d;
    }
    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label,
    .form-floating > .form-select ~ label {
        color: var(--bs-primary);
        font-weight: 500;
        opacity: 0.85;
    }
    .card-header {
        background: linear-gradient(45deg, #0d6efd, #0a58ca);
    }
    /* Logo hover effect */
    .logo-preview-wrap {
        transition: transform 0.3s ease;
        cursor: pointer;
    }
    .logo-preview-wrap:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/company_setting.js' %}"></script>
<script src="{% static 'js/region_township.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const logoInput = document.getElementById('id_logo');
        const logoPreview = document.getElementById('logo-preview');
        const logoPlaceholder = document.getElementById('logo-placeholder');
        const logoWrap = document.querySelector('.logo-preview-wrap');
        
        // Trigger file input when clicking on the logo wrapper
        if (logoWrap && logoInput) {
            logoWrap.addEventListener('click', function() {
                logoInput.click();
            });
        }
        
        // Handle preview display
        if (logoInput) {
            logoInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    // let company_setting.js handle the src update, we just handle the placeholder visibility
                    setTimeout(() => {
                        logoPreview.classList.remove('d-none');
                        if (logoPlaceholder) logoPlaceholder.classList.add('d-none');
                    }, 100);
                }
            });
        }
    });
</script>
{% endblock %}
