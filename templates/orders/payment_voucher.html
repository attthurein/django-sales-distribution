{% extends "base.html" %}
{% load humanize i18n common_extras static %}

{% block extra_css %}
<script src="{% static 'js/html2pdf.bundle.min.js' %}"></script>
<style>
    @font-face {
        font-family: 'Pyidaungsu';
        src: url("{% static 'fonts/Pyidaungsu-Regular.ttf' %}") format('truetype');
        font-weight: normal;
        font-style: normal;
    }

    @font-face {
        font-family: 'Pyidaungsu';
        src: url("{% static 'fonts/Pyidaungsu-Bold.ttf' %}") format('truetype');
        font-weight: bold;
        font-style: normal;
    }

    @media print {
        @page {
            margin: 0;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: white !important;
            font-size: 10pt;
        }

        /* Hide browser headers/footers elements if they are part of the DOM (usually they are browser UI) */
        /* Note: Browser-inserted headers/footers (URL, date) are controlled by @page margin: 0 usually, 
           or browser print settings. We can't fully control user settings but @page margin 0 helps. */

        /* Hide navigation and other non-print elements */
        nav,
        .navbar,
        .no-print,
        header,
        footer,
        .btn,
        .breadcrumb {
            display: none !important;
        }

        .container {
            max-width: 100% !important;
            width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .voucher-container {
            border: none !important;
            box-shadow: none !important;
            padding: 10mm 10mm !important;
            margin: 0 auto !important;
            max-width: 100%;
        }
    }

    .voucher-container {
        background: white;
        padding: 40px;
        border: 1px solid #ddd;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 20px auto;
        font-family: 'Pyidaungsu', 'Noto Sans Myanmar', sans-serif;
    }

    .voucher-header {
        position: relative;
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #333;
        padding-bottom: 20px;
    }

    .company-name {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
        color: #2c3e50;
    }

    .voucher-title {
        font-size: 20px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin: 15px 0;
    }

    .voucher-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
    }

    .meta-group {
        display: flex;
        flex-direction: column;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .info-box {
        border: 1px solid #eee;
        padding: 15px;
        border-radius: 4px;
    }

    .info-title {
        font-weight: bold;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 10px;
        color: #555;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .label {
        color: #666;
        min-width: 100px;
    }

    .value {
        font-weight: 500;
        text-align: right;
    }

    .amount-box {
        background-color: #f8f9fa;
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        margin: 30px 0;
        border-radius: 8px;
    }

    .amount-label {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
    }

    .amount-value {
        font-size: 28px;
        font-weight: bold;
        color: #2c3e50;
    }

    .signature-section {
        display: flex;
        justify-content: space-between;
        margin-top: 60px;
        padding-top: 20px;
    }

    .signature-box {
        text-align: center;
        width: 200px;
    }

    .signature-line {
        border-top: 1px solid #333;
        margin-bottom: 10px;
    }

    .footer-note {
        text-align: center;
        margin-top: 40px;
        font-size: 12px;
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="no-print mb-3 container text-center">
    <button class="btn btn-primary js-print" onclick="window.print()">
        <i class="bi bi-printer"></i> {% trans "Print" %}
    </button>
    <button onclick="downloadPDF()" class="btn btn-outline-danger">
        <i class="bi bi-file-pdf"></i> {% trans "Download PDF" %}
    </button>
    <a href="{% url 'orders:order_detail' payment.order.id %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> {% trans "Back to Order" %}
    </a>
</div>

<div class="voucher-container" id="voucher-content">
    <!-- Header -->
    <div class="voucher-header">
        {% if company_setting and company_setting.logo %}
        <div style="position: absolute; left: 0; top: 0;">
            <img src="{{ company_setting.logo.url }}" alt="Logo" style="height: 120px; width: auto;">
        </div>
        {% endif %}
        <div class="company-name">
            {% if company_setting and company_setting.shop_name %}<div class="h2 mb-1">{{ company_setting.shop_name }}
            </div>{% endif %}
            {% if company_setting and company_setting.name %}<div class="h4 text-muted mb-0">{{ company_setting.name }}
            </div>{% else %}Sales Distribution{% endif %}
        </div>
        <div class="small text-muted">
            {% if company_setting.address %}{{ company_setting.address }}<br>{% endif %}
            {% if company_setting.phone %}{{ company_setting.phone }}{% endif %}
        </div>
        <div class="voucher-title">{% trans "Payment Voucher" %}</div>
    </div>

    <!-- Meta Info -->
    <div class="voucher-meta">
        <div class="meta-group text-start">
            <div><span class="label">{% trans "Voucher No" %}:</span> <span class="fw-bold">{{ payment.voucher_number
                    }}</span></div>
            <div><span class="label">{% trans "Date" %}:</span> {{ payment.payment_date|date:"d F Y" }}</div>
        </div>
        <div class="meta-group text-end">
            <div><span class="label">{% trans "Ref No" %}:</span> {{ payment.reference_number|default:"-" }}</div>
            <div><span class="label">{% trans "Method" %}:</span> {{ payment.payment_method.name_en }}</div>
        </div>
    </div>

    <!-- Info Grid -->
    <div class="info-grid">
        <div class="info-box">
            <div class="info-title">{% trans "Customer Details" %}</div>
            <div class="info-row">
                <span class="label">{% trans "Name" %}:</span>
                <span class="value">{{ payment.order.customer.name }}</span>
            </div>
            <div class="info-row">
                <span class="label">{% trans "Phone" %}:</span>
                <span class="value">{{ payment.order.customer.phone }}</span>
            </div>
        </div>
        <div class="info-box">
            <div class="info-title">{% trans "Order Details" %}</div>
            <div class="info-row">
                <span class="label">{% trans "Order No" %}:</span>
                <span class="value">{{ payment.order.order_number }}</span>
            </div>
            <div class="info-row">
                <span class="label">{% trans "Order Total" %}:</span>
                <span class="value">{{ payment.order.total_amount|intcomma }}</span>
            </div>
        </div>
    </div>

    <!-- Amount Box -->
    <div class="amount-box">
        <div class="amount-label">{% trans "Amount Received" %}</div>
        <div class="amount-value">{{ payment.payment_method.name_en }} - {{ payment.amount|intcomma }} <small
                style="font-size: 16px;">{% currency_suffix %}</small></div>
        {% if payment.notes %}
        <div class="mt-2 text-muted fst-italic small">"{{ payment.notes }}"</div>
        {% endif %}
    </div>

    <!-- Signatures -->
    <div class="signature-section">
        <div class="signature-box">
            <div class="small text-muted mb-1">{{ payment.created_by.get_full_name|default:payment.created_by.username
                }}</div>
            <div class="signature-line"></div>
            <div>{% trans "Received By" %}</div>
        </div>
        <div class="signature-box">
            <div class="small text-muted mb-1" style="height: 21px;"></div>
            <div class="signature-line"></div>
            <div>{% trans "Authorized By" %}</div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-note">
        <p>{% if company_setting.footer_text %}{{ company_setting.footer_text|linebreaksbr }}{% else %}{% trans "Thank
            you for your business!" %}{% endif %}</p>
        <p class="small text-muted">Generated on {{ payment.created_at|date:"d-m-Y H:i" }}</p>
    </div>
</div>

<script>
    function downloadPDF() {
        const element = document.getElementById('voucher-content');
        const opt = {
            margin: 5,
            filename: 'Voucher_{{ payment.voucher_number }}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a5', orientation: 'portrait' }
        };
        // Use html2pdf to save the file
        html2pdf().set(opt).from(element).save();
    }
</script>
{% endblock %}